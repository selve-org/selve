generator client {
  provider = "prisma-client-py"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String       @id @default(cuid())
  email               String       @unique
  name                String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  clerkId             String       @unique
  isArchived          Boolean      @default(false)
  archivedAt          DateTime?
  archiveMetadata     Json?
  inviteLinksSent     InviteLink[] @relation("InviterRelation")
  inviteLinksReceived InviteLink[] @relation("TargetRelation")
  profile             Profile?
  responsesAbout      Response[]   @relation("ResponsesAbout")
  responsesGiven      Response[]   @relation("ResponsesGiven")

  // Agentic chatbot relations
  notes               UserNote[]
  securityIncidents   SecurityIncident[]
  riskProfile         UserRiskProfile?
  conversationInsights ConversationInsight[]

  // Friend assessments (both directions)
  assessmentsReceived FriendAssessment[] @relation("AssessmentTarget")
  assessmentsGiven    FriendAssessment[] @relation("AssessmentAssessor")
}

model Profile {
  id          String   @id @default(uuid())
  userId      String   @unique
  bio         String?
  avatarUrl   String?
  personality Json?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
}

// ============================================================================
// Third-Party Assessment Models - FUTURE FEATURE (Not Yet Implemented)
// ============================================================================
// These models support asking friends/colleagues to answer questions about you
// to get a 360-degree personality view. Currently not used in the SELVE assessment.

model Question {
  id           String     @id @default(uuid())
  text         String
  category     String?
  isThirdParty Boolean    @default(false)
  createdAt    DateTime   @default(now())
  responses    Response[]
}

model Response {
  id               String   @id @default(uuid())
  questionId       String
  answeredById     String
  aboutUserId      String
  answer           String
  
  // Friend Assessment Quality Tracking
  notSure          Boolean  @default(false)  // "Not Sure" button tracking
  responseTime     Int?                      // Response time in milliseconds
  qualityScore     Float?                    // 0-100 quality score
  flaggedMalicious Boolean  @default(false)  // Detect sabotage attempts
  
  createdAt        DateTime @default(now())
  aboutUser        User     @relation("ResponsesAbout", fields: [aboutUserId], references: [id])
  answeredByUser   User     @relation("ResponsesGiven", fields: [answeredById], references: [id])
  question         Question @relation(fields: [questionId], references: [id])
}

// Friend Assessment Response - Using SELVE Item Pool
model FriendResponse {
  id               String    @id @default(uuid())
  inviteId         String    @unique  // One-to-one with InviteLink
  
  // Response Data
  responses        Json      // Array of {item_id, value, not_sure, response_time}
  qualityScore     Float     // 0-100 calculated quality score
  totalTime        Int       // Total completion time in milliseconds
  
  // Metadata
  completedAt      DateTime
  ipAddress        String?
  userAgent        String?
  
  createdAt        DateTime  @default(now())
  
  invite           InviteLink @relation(fields: [inviteId], references: [id], onDelete: Cascade)
  
  @@index([completedAt])
}

// UI Notifications
model Notification {
  id               String    @id @default(uuid())
  userId           String
  type             String    // "friend_completed" | "invite_reminder" | "profile_updated"
  title            String
  message          String
  link             String?   // Navigation link (e.g., "/profile")
  read             Boolean   @default(false)
  readAt           DateTime?
  
  createdAt        DateTime  @default(now())
  
  @@index([userId, read])
  @@index([userId, createdAt])
}

model InviteLink {
  id               String           @id @default(uuid())
  inviteCode       String           @unique  // NanoID(28) for security
  inviterId        String
  targetId         String?
  
  // Status & Expiration
  status           String           @default("pending")  // "pending" | "completed" | "expired" | "abandoned"
  expiresAt        DateTime                              // Auto-expire after 7 days (extendable)
  completedAt      DateTime?
  
  // Friend Metadata
  friendEmail      String?
  friendNickname   String?
  relationshipType String?          // "friend" | "sibling" | "parent" | "partner" | "coworker"
  
  // Analytics & Tracking
  openedAt         DateTime?
  startedAt        DateTime?
  abandonedAt      DateTime?
  deviceType       String?          // "mobile" | "desktop" | "tablet"
  
  // Abuse Prevention
  ipAddress        String?
  userAgent        String?
  
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  inviter          User             @relation("InviterRelation", fields: [inviterId], references: [id])
  target           User?            @relation("TargetRelation", fields: [targetId], references: [id])
  friendResponse   FriendResponse?  // One-to-one relation to friend response
  
  @@index([inviterId, status])
  @@index([expiresAt])
  @@index([ipAddress, createdAt])
}

model RateLimit {
  id           String   @id @default(cuid())
  userId       String
  invitesSent  Int      @default(0)
  windowStart  DateTime
  windowEnd    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([userId, windowStart])
  @@index([userId, windowEnd])
}

// ============================================================================
// SELVE Assessment Models - Psychology Profiling System
// ============================================================================

model AssessmentSession {
  id                   String              @id @default(cuid())
  userId               String?
  clerkUserId          String?             // Clerk user ID for authenticated users
  status               String              @default("in-progress") // "in-progress", "completed", "abandoned"
  isCurrent            Boolean             @default(true)  // Whether this is the user's current active assessment
  responses            Json                // Personality question responses (question_id -> score)
  demographics         Json?               // Demographic data (age, country, etc.)
  pendingQuestions     Json?               // Set of question IDs currently shown to user
  answerHistory        Json?               // Ordered list of question IDs as answered
  backNavigationCount  Int                 @default(0)
  backNavigationLog    Json?               // Detailed log of back navigation behavior
  metadata             Json?               // Additional session metadata
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  completedAt          DateTime?
  archivedAt           DateTime?           // When this assessment was archived (user started a new one)
  result               AssessmentResult?   // One-to-one relation to results
  friendInsightGenerations FriendInsightGeneration[] // History of AI-generated friend insights
  
  @@index([clerkUserId, isCurrent])       // Fast lookup for user's current assessment
  @@index([clerkUserId, completedAt])     // Fast lookup for user's assessment history
}

// ============================================================================
// Friend Insight AI-Generated Narratives
// ============================================================================

model FriendInsightGeneration {
  id                   String              @id @default(cuid())
  sessionId            String
  session              AssessmentSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Inputs (frozen at generation time for reproducibility)
  selfScores           Json                // { LUMEN: 72, AETHER: 45, ... }
  friendScores         Json                // Aggregated: { LUMEN: 65, AETHER: 58, ... }
  blindSpots           Json                // [{ dimension: "AETHER", selfScore: 45, friendScore: 58, diff: 13 }]
  friendCount          Int                 // Number of friends included
  friendResponseIds    String[]            // Array of FriendResponse IDs used
  
  // Change detection (avoids re-comparing arrays each request)
  inputHash            String              // SHA256 of sorted(friendResponseIds) + selfScores + friendScores
  
  // Timestamps for when scores were captured (for analytics when user retakes)
  selfScoresFrozenAt   DateTime
  friendScoresFrozenAt DateTime
  
  // Output
  narrative            String?             // The generated text (nullable if generation failed)
  
  // Generation metadata
  generationModel      String?             // e.g., "gpt-4o-mini"
  promptTokens         Int?                // Input tokens used
  completionTokens     Int?                // Output tokens used
  generationCost       Float?              // OpenAI cost in USD
  generationError      String?             // Error message if failed
  
  // Tracking
  regeneratedBecause   String?             // "new-friend-response" | "self-retake" | "manual" | "initial"
  tone                 String              @default("friendly") // Future: "gentle", "mentor", etc.
  
  createdAt            DateTime            @default(now())
  isCurrent            Boolean             @default(true) // Whether this is the active generation
  
  @@index([sessionId])
  @@index([inputHash])
}

model AssessmentResult {
  id                   String              @id @default(cuid())
  sessionId            String              @unique
  userId               String?
  clerkUserId          String?             // Clerk user ID for authenticated users
  isCurrent            Boolean             @default(true)  // Whether this is the user's current/latest result
  
  // Sharing & Privacy
  isPublic             Boolean             @default(false) // Whether result can be viewed via public link
  publicShareId        String?             @unique         // Unique ID for public sharing (nanoid)
  sharedAt             DateTime?                           // When the result was first shared
  
  // Dimension Scores (0-100)
  scoreLumen           Float               // Mindful Curiosity
  scoreAether          Float               // Rational Reflection
  scoreOrpheus         Float               // Compassionate Connection
  scoreOrin            Float               // Structured Harmony
  scoreLyra            Float               // Creative Expression
  scoreVara            Float               // Purposeful Commitment
  scoreChronos         Float               // Adaptive Spontaneity
  scoreKael            Float               // Bold Resilience
  
  // Narrative
  narrative            Json                // Complete OpenAI-generated narrative
  archetype            String?             // Primary archetype (e.g., "The Pioneer")
  profilePattern       String?             // Profile pattern (e.g., "Visionary Leader")
  
  // Validation & Quality
  consistencyScore     Float?              // Response consistency (0-100)
  attentionScore       Float?              // Attention check score (0-100)
  validationFlags      Json?               // Any quality flags
  
  // Cost tracking
  generationCost       Float?              // OpenAI API cost in USD
  generationModel      String?             // Model used (e.g., "gpt-4o-mini")
  
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  
  session              AssessmentSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([clerkUserId])
  @@index([clerkUserId, isCurrent])       // Fast lookup for user's current result
}

model AssessmentTemplate {
  id                   String              @id @default(uuid())
  name                 String              @unique
  description          String?
  version              String              @default("1.0")
  
  // Item Pool
  items                Json                // Complete item pool with correlations
  dimensions           Json                // Dimension definitions
  
  // Configuration
  minItemsPerDimension Int                 @default(2)
  maxTotalItems        Int                 @default(54)
  uncertaintyThreshold Float               @default(0.3)
  
  isActive             Boolean             @default(true)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  
  @@index([isActive])
}

// ============================================================================
// User Testimonials - "Share Your Story" Feature
// ============================================================================

model Testimonial {
  id               String    @id @default(cuid())
  
  // User Info
  firstName        String                    // Required - display name
  lastName         String?                   // Optional - only show initial
  role             String?                   // e.g., "Product Manager"
  company          String?                   // e.g., "Google"
  email            String?                   // For follow-up (not displayed)
  
  // Content
  message          String                    // The testimonial text (required)
  rating           Int?                      // 1-5 stars (optional)
  
  // Sentiment Analysis (using npm 'sentiment' package)
  sentimentScore   Float?                    // -5 to +5 score
  sentimentLabel   String?                   // "positive" | "neutral" | "negative"
  
  // Moderation & Display
  isPlaceholder    Boolean   @default(false) // Seed/dummy data flag
  isApproved       Boolean   @default(false) // Must be approved to show on homepage
  isFeatured       Boolean   @default(false) // Highlighted testimonials
  
  // User linking (optional - for authenticated users)
  userId           String?                   // Clerk user ID if submitted by authenticated user
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@index([isApproved, isPlaceholder])
  @@index([createdAt])
}

// ============================================================================
// Newsletter Subscribers
// ============================================================================

model NewsletterSubscriber {
  id               String    @id @default(cuid())
  email            String    @unique
  
  // Link to registered user (if they have an account)
  clerkUserId      String?
  
  // Subscription status
  status           String    @default("active")  // "active" | "unsubscribed" | "bounced"
  
  // Timestamps
  subscribedAt     DateTime  @default(now())
  unsubscribedAt   DateTime?
  
  // Email preferences (for future use)
  preferences      Json?     // { newsletters: true, productUpdates: true, etc. }
  
  // Tracking
  source           String?   // "website" | "signup" | "import" etc.
  ipAddress        String?
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@index([status])
  @@index([clerkUserId])
}

// ============================================================================
// SELVE Chatbot Models - AI-Powered Personality Assistant
// ============================================================================

model ChatSession {
  id                String              @id @default(cuid())
  userId            String
  clerkUserId       String

  title             String?             // Auto-generated from first message
  status            String              @default("active")  // "active" | "archived"
  totalTokens       Int                 @default(0)
  compressionCount  Int                 @default(0)
  metadata          Json?               // Conversation state: topics, emotional_tone, unresolved, etc.

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  lastMessageAt     DateTime            @default(now())

  messages          ChatMessage[]
  episodicMemories  EpisodicMemory[]
  semanticMemories  SemanticMemory[]
  insights          ConversationInsight[]

  @@index([userId, status, lastMessageAt])
  @@index([clerkUserId, status])
}

model ChatMessage {
  id                String              @id @default(cuid())
  sessionId         String
  session           ChatSession         @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role              String              // "user" | "assistant" | "system"
  content           String
  tokenCount        Int                 @default(0)
  model             String?             // "claude-3-5-sonnet" | "gpt-4o-mini"
  provider          String?             // "anthropic" | "openai"
  cost              Float?

  retrievedContextIds Json?             // IDs of knowledge/memories used
  confidenceTags    Json?               // [{text, confidence, source}]

  createdAt         DateTime            @default(now())
  isCompressed      Boolean             @default(false)
  compressedAt      DateTime?

  @@index([sessionId, createdAt])
}

model EpisodicMemory {
  id                String              @id @default(cuid())
  userId            String
  sessionId         String?
  session           ChatSession?        @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  title             String
  summary           String
  keyInsights       Json                // [{insight, confidence, source}]
  unresolvedTopics  Json?
  emotionalState    String?

  sourceMessageIds  String[]
  compressionModel  String              // Model used for compression
  compressionCost   Float?

  vectorId          String?             // Qdrant point ID
  embedded          Boolean             @default(false)

  createdAt         DateTime            @default(now())
  spanStart         DateTime            // Start time of compressed conversation
  spanEnd           DateTime            // End time of compressed conversation
  lastAccessedAt    DateTime            @default(now())

  @@index([userId, spanStart])
}

model SemanticMemory {
  id                String              @id @default(cuid())
  userId            String
  sessionId         String?
  session           ChatSession?        @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  category          String              // "behavior_pattern" | "relationship_insight" | "goal" | "value"
  content           String
  confidence        String              // "CONFIRMED" | "OBSERVED" | "HYPOTHESIS"

  evidenceCount     Int                 @default(1)
  firstObservedAt   DateTime
  lastObservedAt    DateTime
  sourceMessageIds  String[]
  relatedDimension  String?             // LUMEN, AETHER, ORPHEUS, etc.

  vectorId          String?             // Qdrant point ID
  embedded          Boolean             @default(false)

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  isActive          Boolean             @default(true)

  @@index([userId, confidence, isActive])
}

model ContentValidation {
  id                String              @id @default(cuid())

  sourceType        String              // "tim_lahaye" | "youtube" | "web" | "reddit"
  sourceUrl         String?
  originalContent   String
  validatedContent  String

  validationStatus  String              @default("pending")  // "pending" | "approved" | "rejected"
  validatedBy       String?             // "llm" | "human:{admin_id}"
  validationNotes   String?

  isIndexed         Boolean             @default(false)
  vectorId          String?             // Qdrant point ID

  createdAt         DateTime            @default(now())
  validatedAt       DateTime?

  @@index([sourceType, validationStatus])
}

model ChatbotKnowledgeSync {
  id                String              @id @default(cuid())
  userId            String

  syncType          String              // "assessment_result" | "friend_assessment"
  sourceId          String              // AssessmentResult ID or FriendResponse ID
  sourceType        String

  status            String              @default("pending")  // "pending" | "completed" | "failed"
  vectorId          String?             // Qdrant point ID
  errorMessage      String?

  syncedAt          DateTime?
  createdAt         DateTime            @default(now())

  @@index([userId, syncType, status])
}

model ChatbotAnalytics {
  id                String              @id @default(cuid())
  userId            String
  sessionId         String

  messageCount      Int                 @default(0)
  totalTokensUsed   Int                 @default(0)
  totalCost         Float               @default(0)
  avgResponseTime   Float?

  compressionTriggers Int               @default(0)

  provider          String?             // "anthropic" | "openai"
  model             String?

  date              DateTime            @default(now())

  @@index([userId, date])
  @@index([provider, model, date])
}

// =============================================================================
// Agentic Chatbot Additions
// =============================================================================

/// Persistent notes about users that the chatbot stores for future reference.
/// These help the chatbot remember key information across sessions.
model UserNote {
  id          String    @id @default(cuid())
  userId      String    // Internal user ID
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    String    @default("observation")
  content     String    @db.VarChar(500)
  importance  Int       @default(3)
  source      String    @default("chatbot")
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId, category])
  @@index([userId, importance])
  @@index([expiresAt])
}

/// Records security incidents for audit and risk tracking
model SecurityIncident {
  id              String    @id @default(cuid())
  userId          String?
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  clerkUserId     String?
  sessionId       String?
  incidentType    String
  riskScore       Float
  detectionTier   Int       @default(1)
  flags           Json      @default("[]")
  messagePreview  String?   @db.VarChar(100)
  wasBlocked      Boolean   @default(false)
  ipHash          String?
  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([clerkUserId])
  @@index([incidentType])
  @@index([createdAt])
}

/// Aggregated risk profile for a user
model UserRiskProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  totalScore      Float     @default(0)
  incidentCount   Int       @default(0)
  isFlagged       Boolean   @default(false)
  flaggedAt       DateTime?
  lastIncidentAt  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([isFlagged])
  @@index([totalScore])
}

/// Insights extracted from conversations for better personalization
model ConversationInsight {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId       String?
  session         ChatSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  insightType     String
  content         String      @db.VarChar(500)
  confidence      Float       @default(0.7)
  dimensions      Json        @default("[]")
  createdAt       DateTime    @default(now())

  @@index([userId, insightType])
  @@index([sessionId])
}

/// Assessment of a user by their friend/peer
model FriendAssessment {
  id              String    @id @default(cuid())
  targetUserId    String
  targetUser      User      @relation("AssessmentTarget", fields: [targetUserId], references: [id], onDelete: Cascade)
  assessorId      String
  assessor        User      @relation("AssessmentAssessor", fields: [assessorId], references: [id], onDelete: Cascade)
  relationship    String    @default("friend")
  scoreLumen      Float?
  scoreAether     Float?
  scoreOrpheus    Float?
  scoreOrin       Float?
  scoreLyra       Float?
  scoreVara       Float?
  scoreChronos    Float?
  scoreKael       Float?
  notes           String?   @db.Text
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([targetUserId, assessorId])
  @@index([targetUserId])
  @@index([assessorId])
}
